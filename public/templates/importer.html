<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JCRS CSV Importer</title>

    <!-- Dropzone CSS (pin to a stable build) -->
    <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" />
    <link rel="stylesheet" href="{{ basePath }}/styles.css" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <link rel="icon" href="{{ basePath }}/du-main-logo.svg" type="image/svg+xml">
  </head>
  <body>
    <div class="wrap">
      <h1>JCRS CSV Importer <span class="DU-title-red">@ DU</span></h1>
      <p class="notice">Drag & drop a <strong>.csv</strong> file into the box below (or click it). The server will parse and insert rows into the database.</p>

      Current Status: <div id="status" class="status" role="status" aria-live="polite">Idle.</div>

      <!-- The Dropzone element. The JS below will attach to this by ID. -->
      <form id="csvDropzone" action="{{ basePath }}/upload" class="dropzone" enctype="multipart/form-data">
        <div class="dz-message" data-dz-message>
          <span>Drop your <strong>.csv</strong> here or click to select.</span>
        </div>
      </form>
    </div>

    <footer>
      <span><a href="{{ jcrsBasePath }}">JCRS @ DU PUI</a> | v{{ packageVersion }}</span>
    </footer>

    <!-- Dropzone JS (must come before our init script) -->
    <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
    <script>
    // must run before Dropzone loads
    window.Dropzone = window.Dropzone || {};
    window.Dropzone.autoDiscover = false;
    </script>

    <script>
      // Initialize Dropzone once the DOM is ready, error handling if it fails to load
      window.addEventListener('DOMContentLoaded', function () {
        const statusEl = document.getElementById('status');

        if (typeof window.Dropzone === 'undefined') {
          if (statusEl) statusEl.textContent = 'Dropzone failed to load. Check your network/ad blocker.';
          console.error('Dropzone is undefined. Did the script fail to load?');
          return;
        }


      const dz = new Dropzone('#csvDropzone', {
        url: '{{ basePath }}/upload',
        paramName: 'file',
        maxFilesize: 70,
        acceptedFiles: 'text/csv,.csv,.CSV',
        timeout: 0,
        createImageThumbnails: false,
        clickable: '#csvDropzone',
        maxFiles: 1,
      });

        dz.on('init', function() {statusEl.textContent = 'Ready. Drop a .csv or click the box.';});
        dz.on('addedfile', function(file) {statusEl.textContent = 'File added: ' + (file && file.name ? file.name : '(unnamed)') + '. Ready to upload…';});
        dz.on('sending', function() {statusEl.textContent = 'Uploading…';});
        dz.on('totaluploadprogress', function(progress) {statusEl.textContent = 'Uploading… ' + Math.round(progress) + '%';});

        dz.on('error', function (file, err, xhr) {
          let msg = '';
          if (err && typeof err === 'object' && err.message) {
            msg = err.message;
          } else if (typeof err === 'string') {
            msg = err;
          } else if (xhr && xhr.responseText) {
            msg = xhr.responseText;
          } else if (file && file.xhr && file.xhr.responseText) {
            msg = file.xhr.responseText;
          } else {
            msg = 'Unknown error';
          }
          statusEl.textContent = 'Failed. QC your CSV and please try again.';
        });

        dz.on('maxfilesexceeded', function(file) {statusEl.textContent = 'Too many files. Only one file at a time.';});
        dz.on('processing', function(file) {statusEl.textContent = 'Uploading…';});
        dz.on('complete', function(file) {
          const status = file && file.xhr ? file.xhr.status : '(no status)';
          const statusText = file && file.xhr ? file.xhr.statusText : '';
          console.log('Upload complete:', status, statusText);
        });
        dz.on('queuecomplete', async function() {
          if (!statusEl.textContent.includes('Failed')) {
            statusEl.textContent = 'Successful. You can upload another file.';
            await new Promise(res => setTimeout(res, 1000));
            dz.removeAllFiles();
            statusEl.textContent = 'Successful. You can upload another file.';
          } else {
            await new Promise(res => setTimeout(res, 1000));
            dz.removeAllFiles();
            statusEl.textContent = 'Failed. QC your CSV and please try again.';
          }
        });
      });
    </script>
  </body>
</html>
